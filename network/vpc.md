`VPN (Virtual Private Network)`란 가상의 사설망을 의미한다.
보안상의 이유로 회사내 직원간 네트워크를 분리하고 싶다면 건물의 내부선을 다 뜯어고쳐야만 한다. 이를 위해 가상의 망인 VPN을 사용한다.

![](https://miro.medium.com/max/1400/1*5ewVo87W9HPO_0csubAMOQ.png)


VPN을 사용하면 네트워크A와 네트워크B가 실제로 같은 네트워크상에 있지만 논리적으로는 다른 네트워크인것 처럼 동작한다. 이것을 '가상 사설망'이라고 한다.

## 1. VPC(Virtual Private Cloud)

먼저 VPC를 사용하지 않는 구조를 살펴보자.

![](https://miro.medium.com/max/1400/1*hZGJeN-4F6fLtus5XBJC_w.png)

인스턴스들이 서로 거미줄처럼 연결되고 인터넷과 연결된다. 이런 구조는 시스템의 복잡도를 높이며 하나의 인스턴스만 추가되도 모든 인스턴스를 수정해야 하는 불편함이 생긴다.

![](https://miro.medium.com/max/1400/1*Ehn4uEQMtbmdPsU6MxVc3Q.png)

VPC를 적용하면 얻는 장점은 다음과 같다.
- VPC별로 네트워크 구성 가능
- 각각의 VPC에 따라 다르게 네트워크 설정을 줄 수 있다.
- 각각의 VPC는 독립된 네트워크처럼 작동한다.
- 특정 사용자의 리소스들이 논리적으로 격리된 네트워크에서 생성되기 때문에 다른 사람의 접근을 방지한다

## 2. VPC 구축 과정

![](https://miro.medium.com/max/1400/1*Bjb_sU3iu7_Z9Djeh3Zwdw.png)

VPC를 구축하기 위해서는 VPC의 아이피범위를 `RFC1918` 이라는 사설 아이피대역에 맞추어 구축해야 한다.

한번 설정된 아이피대역은 수정할 수 없으며 각 VPC는 하나의 리전에 종속된다.
VPC는 완전히 독립적이기 때문에 만약 VPC간 통신을 원한다면 VPC 피어링 서비스를 고려해볼 수 있다.

### 2.1 서브넷

![](https://miro.medium.com/max/1400/1*WCucO_PRVCShRY2Swe1HGQ.png)

더 많은 네트워크망을 만들기 위해서 VPC를 여러 서브넷으로 나누게 됩니다.
서브넷은 VPC보다 작은 단위이기 때문에 연히 서브넷 마스크가 더 높으며 더 작은 아이피범위 값을 갖게된다.

각 서브넷은 가용영역안에 존재하며 서브넷안에 `RDS, EC2`와 같은 리소스를 위치시킬 수 있다.

### 2.2 라우팅 테이블과 라우터

![](https://miro.medium.com/max/1400/1*C_j93s0KB4JwfLgck5YFug.png)

네트워크 요청이 발생하면 데이터는 `라우터`로 향하게 된다.
- 라우터
	- 목적지
- 라우팅 테이블
	- 목적지에 대한 이정표
데이터는 라우터로 향하게 되며 네트워크 요청은 각각 정의된 라우팅 테이블에 따라 작동한다.

서브넷A의 라우팅 테이블의 경우 `172.31.0.0/16`으로 되어있는데, 이는 VPC안의 네트워크 범위를 갖는 네트워크 요청은 찾겠다는 의미이다.

하지만 그 이외의 외부로 통하는 트래픽은 처리할 수 없다. 이때 인터넷 게이트웨이를 사용한다.

### 2.3 인터넷게이트웨이

![](https://miro.medium.com/max/1400/1*I_3RxWyOPMj9lQs1xhEebg.png)

- 인터넷게이트웨이
	- VPC와 인터넷을 연결해주는 하나의 관문

서브넷B의 라우팅테이블의 범위는 `0.0.0.0/0`으로 정의되어있다.
라우팅테이블은 가장 먼저 목적지의 주소가 `172.31.0.0/16`에 매칭되는지를 확인한 후 매칭되지 않는다면 `0.0.0.0/0`으로 보낸다. 이는 모든 트래픽에 대하여 `IGA(인터넷 게이트웨이) A`로 향하라는 뜻이다.

- 퍼블릭 서브넷
	- 인터넷과 연결되어있는 서브넷
- 프라이빗 서브넷
	- 인터넷과 연결 되어있지 않는 서브넷

### 2.4  네트워크 ACL과 보안그룹

![](https://miro.medium.com/max/1400/1*hyUQHofL7FkFtJ3FnZ1IJA.png)

네트워크 ACL, 보안그룹은 방화벽과 같은 역할
인바운드 트래픽과 아웃바운드 트래픽 보안정책을 설정할 수 있다.

- 보안그룹
	- Stateful하게 작동
	- 기본설정은 모든 허용을 차단하도록 되어있다.
	- 필요한 설정은 허용해 줘야한다
	- 보안그룹별로 별도의 트래픽 설정이 가능하다

- 네트워크 ACL
	- Stateless하게 작동
	- 기본설정은 모든 트래픽을 허용한다.
	- 불필요한 트래픽을 막도록 설정해줘야 한다.
	- 서브넷 단위로 적용되며 리소스 별로는 설정할 수 없다.
	- 네트워크 ACL과 보안그룹이 충돌한다면 보안그룹이 우선순위가 더 높다.

### 2.5 NAT 게이트웨이

![](https://miro.medium.com/max/1400/1*jS8gNWRUH1SFi1XAHFU0aQ.png)

- NAT 게이트웨이
	- 프라이빗서브넷이 인터넷과 통신하기 위한 아웃바운드 인스턴스

프라이빗 네이트워크가 외부에서 요청되는 인바운드는 필요없더라도 인스턴스의 펌웨어나 주기적인 업테이트가 필요하여 아웃바운드 트래픽만 허용되야할 경우가 있다.

이때 퍼블릿 서브넷상에서 동작하는 `NAT 게이트웨이`는 프라이빗서브넷에서 외부로 요청하는 아웃바운드 트래픽을 받아 인터넷게이트웨이와 연결한다.

**참고 자료**
- https://www.44bits.io/ko/post/understanding_aws_vpc
- https://developerbee.tistory.com/207
